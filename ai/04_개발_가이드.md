# 04. 개발 가이드

## 🚀 개발 환경 설정

### 1. 시스템 요구사항
- **Python**: 3.11.13 (정확한 버전 필수)
- **OS**: Windows 10/11, macOS 10.15+, Ubuntu 18.04+
- **메모리**: 최소 8GB RAM (권장 16GB)
- **저장공간**: 최소 2GB 여유공간

### 2. 환경 설정

#### 자동 설치 (권장)
```bash
# 레포지토리 클론
git clone https://github.com/your-username/Jober_ai.git
cd Jober_ai

# pyenv를 사용한 Python 버전 관리
pyenv install 3.11.13
pyenv local 3.11.13

# 의존성 설치
pip install -r requirements.txt
```

#### Poetry 사용 (권장)
```bash
# Poetry 설치
curl -sSL https://install.python-poetry.org | python3 -

# 프로젝트 의존성 설치
poetry install

# 개발 도구 포함 설치
poetry install --with dev,docs

# 가상환경 활성화
poetry shell
```

### 3. 환경 변수 설정
```bash
# .env 파일 생성
cat > .env << EOF
GOOGLE_API_KEY=your_gemini_api_key_here
GEMINI_API_KEY=your_gemini_api_key_here
ENVIRONMENT=development
EOF
```

## 🛠️ 개발 도구 설정

### 1. 코드 포맷팅
```bash
# Black 포맷터
black src/ tests/ --line-length 88 --target-version py311

# import 정렬
isort src/ tests/ --profile black
```

### 2. 정적 분석
```bash
# 타입 체킹
mypy src/ --python-version 3.11

# 코드 스타일 검사  
flake8 src/ --max-line-length=88
```

### 3. 테스트 실행
```bash
# 전체 테스트
pytest

# 커버리지 포함
pytest --cov=src --cov-report=term-missing --cov-report=html

# 특정 테스트 파일
pytest test_backend_integration.py -v
```

## 📁 프로젝트 구조

### 디렉토리 구성
```
Jober_ai/
├── src/                    # 메인 소스 코드
│   ├── __init__.py
│   ├── agents/             # AI 에이전트
│   │   ├── __init__.py
│   │   ├── agent1.py       # (미사용)
│   │   └── agent2.py       # 메인 생성 에이전트
│   ├── core/               # 핵심 엔진
│   │   ├── __init__.py
│   │   ├── base_processor.py
│   │   ├── template_generator.py
│   │   ├── index_manager.py
│   │   └── entity_extractor.py
│   ├── tools/              # 전문화된 도구
│   │   ├── __init__.py
│   │   ├── blacklist_tool.py
│   │   ├── whitelist_tool.py
│   │   ├── info_comm_law_tool.py
│   │   ├── date_preprocessor.py
│   │   ├── intent_classifier.py
│   │   └── variable_extractor.py
│   └── utils/              # 유틸리티
│       ├── __init__.py
│       ├── common_init.py
│       ├── data_processor.py
│       └── sample_templates.py
├── data/                   # 원본 가이드라인
├── predata/               # 전처리된 데이터
├── cache/                 # FAISS 인덱스
├── docs/                  # 문서
├── tests/                 # 테스트 (예정)
├── main.py               # CLI 엔트리포인트
├── server.py             # FastAPI 서버
├── api.py                # API 로직
├── config.py             # 설정
└── requirements.txt      # 의존성
```

### 모듈 임포트 규칙
```python
# 절대 경로 임포트 사용
from src.core.template_generator import TemplateGenerator
from src.agents.agent2 import Agent2
from src.tools.date_preprocessor import DatePreprocessor

# 상대 경로 임포트 (같은 패키지 내에서만)
from .base_processor import BaseTemplateProcessor
from ..tools.blacklist_tool import BlacklistTool
```

## 🔧 핵심 컴포넌트 개발

### 1. 새로운 도구(Tool) 추가

#### 도구 기본 구조
```python
# src/tools/custom_tool.py
import os
import sys

# 상위 디렉토리 접근을 위한 path 추가
sys.path.append(os.path.join(os.path.dirname(__file__), '../..'))
from config import GEMINI_API_KEY

class CustomTool:
    """새로운 검증 도구 템플릿"""
    
    def __init__(self, api_key: str = None):
        self.api_key = api_key or GEMINI_API_KEY
        self.predata_cache = None
        
    def load_data(self):
        """데이터 로딩 로직"""
        if self.predata_cache is None:
            # 데이터 로딩 구현
            pass
        return self.predata_cache
    
    def analyze(self, user_input: str, context: str = "") -> dict:
        """분석 로직 구현"""
        return {
            "status": "success",
            "data": "분석 결과",
            "confidence": 0.95
        }
```

#### Agent2에 도구 추가
```python
# src/agents/agent2.py 수정
def __init__(self):
    # 기존 도구들
    self.blacklist_tool = self._init_blacklist_tool()
    self.whitelist_tool = self._init_whitelist_tool() 
    self.guideline_tool = self._init_guideline_tool()
    self.law_tool = self._init_law_tool()
    
    # 새로운 도구 추가
    self.custom_tool = self._init_custom_tool()
    
    self.tools = {
        "blacklist": self.blacklist_tool,
        "whitelist": self.whitelist_tool,
        "guideline": self.guideline_tool,
        "law": self.law_tool,
        "custom": self.custom_tool  # 추가
    }

def _init_custom_tool(self):
    from ..tools.custom_tool import CustomTool
    return CustomTool(api_key=self.api_key)
```

### 2. 새로운 업종 카테고리 추가

#### 카테고리 정의
```python
# src/utils/category_mapping.py (신규 생성)
CATEGORY_MAPPING = {
    "소매업": 9101,
    "부동산": 9102, 
    "교육": 9103,
    "서비스업": 9104,
    "기타": 9105,
    "의료": 9106,  # 새 카테고리 추가
    "금융": 9107   # 새 카테고리 추가
}

CATEGORY_KEYWORDS = {
    9106: ["병원", "의료", "진료", "처방", "건강검진", "예약"],
    9107: ["대출", "투자", "보험", "카드", "금융", "적금"]
}
```

#### 분류 로직 수정
```python  
# src/core/template_generator.py
def classify_category(self, user_input: str) -> int:
    """업종 자동 분류"""
    from ..utils.category_mapping import CATEGORY_KEYWORDS
    
    for category_id, keywords in CATEGORY_KEYWORDS.items():
        if any(keyword in user_input for keyword in keywords):
            return category_id
    return 9105  # 기타
```

### 3. API 엔드포인트 추가

#### 새 엔드포인트 구현
```python
# server.py에 추가
@app.get("/ai/categories")
async def get_categories():
    """지원하는 카테고리 목록 반환"""
    from src.utils.category_mapping import CATEGORY_MAPPING
    return {
        "categories": [
            {"id": cat_id, "name": cat_name} 
            for cat_name, cat_id in CATEGORY_MAPPING.items()
        ]
    }

@app.post("/ai/analyze")  
async def analyze_input(request: AnalysisRequest):
    """입력 텍스트 분석 (템플릿 생성 전 단계)"""
    try:
        analysis = template_api.analyze_input(request.content)
        return {
            "predicted_category": analysis["category"],
            "extracted_variables": analysis["variables"],
            "confidence": analysis["confidence"]
        }
    except Exception as e:
        raise HTTPException(status_code=500, detail=str(e))
```

## 🧪 테스트 작성

### 1. 단위 테스트
```python
# tests/test_agent2.py (신규 생성)
import pytest
from src.agents.agent2 import Agent2

class TestAgent2:
    @pytest.fixture
    def agent2(self):
        return Agent2()
    
    def test_parallel_validation(self, agent2):
        """4-도구 병렬 검증 테스트"""
        user_input = "쿠폰 발급 안내"
        result = agent2.parallel_validate(user_input)
        
        assert result["status"] == "success"
        assert "blacklist" in result["validation_results"]
        assert "whitelist" in result["validation_results"]
        assert "guideline" in result["validation_results"]
        assert "law" in result["validation_results"]
    
    def test_template_generation(self, agent2):
        """템플릿 생성 테스트"""
        user_input = "쿠폰 발급 안내"
        result = agent2.generate_template(user_input)
        
        assert "generated_template" in result
        assert "#{" in result["generated_template"]  # 변수 포함 확인
        assert len(result["generated_template"]) > 50  # 최소 길이 검증
```

### 2. 통합 테스트
```python
# tests/test_integration.py (신규 생성)
import pytest
from api import get_template_api

class TestIntegration:
    @pytest.fixture
    def template_api(self):
        return get_template_api()
    
    @pytest.mark.asyncio
    async def test_end_to_end_flow(self, template_api):
        """전체 플로우 테스트"""
        user_input = "부동산 상담 예약"
        
        # 1. 템플릿 생성
        result = template_api.generate_template(user_input)
        assert result["success"] is True
        
        # 2. JSON 변환
        json_result = template_api.export_to_json(
            result, user_input, user_id=101
        )
        assert json_result["success"] is True
        assert json_result["data"]["template"]["category_id"] == 9102
```

### 3. 성능 테스트
```python
# tests/test_performance.py (신규 생성)
import time
import pytest
from src.core.template_generator import TemplateGenerator

class TestPerformance:
    def test_generation_speed(self):
        """템플릿 생성 속도 테스트"""
        generator = TemplateGenerator(api_key="test_key")
        
        start_time = time.time()
        result = generator.generate_template("쿠폰 발급 안내")
        elapsed_time = time.time() - start_time
        
        # 5초 이내 생성 완료 기대
        assert elapsed_time < 5.0
        assert result is not None
```

## 🔍 디버깅 가이드

### 1. 로깅 설정
```python
# config.py에 추가
import logging

# 개발 환경에서 상세 로깅
if os.getenv("ENVIRONMENT") == "development":
    logging.basicConfig(
        level=logging.DEBUG,
        format='%(asctime)s - %(name)s - %(levelname)s - %(message)s'
    )
else:
    logging.basicConfig(level=logging.INFO)

logger = logging.getLogger("jober_ai")
```

### 2. 단계별 디버깅
```python
# src/agents/agent2.py
def generate_template(self, user_input: str):
    logger.debug(f"Input received: {user_input}")
    
    # 1. 병렬 검증
    validation_start = time.time()
    validation_results = self.parallel_validate(user_input)
    logger.debug(f"Validation completed in {time.time() - validation_start:.2f}s")
    
    # 2. 컨텍스트 검색
    context_start = time.time()
    context = self.search_context(user_input)
    logger.debug(f"Context search completed in {time.time() - context_start:.2f}s")
    
    # 3. 템플릿 생성
    generation_start = time.time()
    template = self.generate_with_context(validation_results, context)
    logger.debug(f"Template generated in {time.time() - generation_start:.2f}s")
    
    return template
```

### 3. 에러 처리 패턴
```python
# 표준 에러 처리
try:
    result = dangerous_operation()
except SpecificException as e:
    logger.error(f"Expected error occurred: {e}")
    return {"error": str(e), "success": False}
except Exception as e:
    logger.exception("Unexpected error occurred")
    return {"error": "Internal server error", "success": False}
```

## 📊 성능 최적화

### 1. 캐싱 전략
```python
# 메모리 캐싱
from functools import lru_cache

class Agent2:
    @lru_cache(maxsize=128)
    def get_cached_validation(self, user_input_hash: str):
        """검증 결과 캐싱"""
        return self.parallel_validate(user_input_hash)
```

### 2. 비동기 처리
```python
# async/await 패턴 활용
import asyncio

async def parallel_tool_execution(self, user_input):
    """도구들을 비동기로 병렬 실행"""
    tasks = [
        self.blacklist_tool.analyze_async(user_input),
        self.whitelist_tool.analyze_async(user_input),
        self.guideline_tool.analyze_async(user_input),
        self.law_tool.analyze_async(user_input)
    ]
    results = await asyncio.gather(*tasks)
    return dict(zip(["blacklist", "whitelist", "guideline", "law"], results))
```

### 3. 메모리 관리
```python
# 대용량 데이터 처리시 제너레이터 활용
def process_large_dataset(self):
    """메모리 효율적인 데이터 처리"""
    for chunk in self.read_data_in_chunks():
        yield self.process_chunk(chunk)
        # 메모리 해제
        del chunk
```

---

**이전 문서**: [03_시스템_아키텍처.md](./03_시스템_아키텍처.md)  
**다음 문서**: [05_배포_가이드.md](./05_배포_가이드.md)