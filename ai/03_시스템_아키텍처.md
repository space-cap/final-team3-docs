# 03. 시스템 아키텍처

## 🏗️ 전체 시스템 개요

JOBER AI는 **Agent-Based AI Architecture**를 채택하여 높은 확장성과 모듈성을 제공합니다.

```
┌─────────────────────────────────────────────────────────────┐
│                        JOBER AI System                     │
├─────────────────────────────────────────────────────────────┤
│  FastAPI Server (server.py)                                │
│  ├── POST /ai/templates                                     │  
│  └── GET /health                                            │
├─────────────────────────────────────────────────────────────┤
│  API Layer (api.py)                                         │
│  ├── TemplateAPI Class                                      │
│  ├── JSON Export                                            │
│  └── Health Check                                           │
├─────────────────────────────────────────────────────────────┤
│  Core Engine (src/core/)                                    │
│  ├── TemplateGenerator                                      │
│  ├── IndexManager (FAISS)                                   │
│  └── EntityExtractor                                        │  
├─────────────────────────────────────────────────────────────┤
│  Agent System (src/agents/)                                 │
│  └── Agent2 (4-Tool Parallel Validation)                   │
├─────────────────────────────────────────────────────────────┤
│  Specialized Tools (src/tools/)                             │
│  ├── BlacklistTool     ├── WhitelistTool                   │
│  ├── InfoCommLawTool   ├── GuidelineTool                   │
│  ├── DatePreprocessor  ├── IntentClassifier                │
│  └── VariableExtractor                                      │
├─────────────────────────────────────────────────────────────┤
│  Data Layer                                                  │
│  ├── data/ (원본 가이드라인)                                │
│  ├── predata/ (전처리된 데이터)                             │
│  └── cache/ (FAISS 인덱스)                                  │
└─────────────────────────────────────────────────────────────┘
```

## 🤖 Agent2 아키텍처

**Agent2**는 시스템의 핵심 AI 엔진으로, 4개의 전문화된 도구를 병렬로 실행합니다.

### 4-Tool Parallel Validation System

```
User Input: "쿠폰 발급 안내"
           │
           ▼
    ┌─────────────────┐
    │   Agent2 Core   │
    │   (Orchestrator)│
    └─────────┬───────┘
              │
    ┌─────────┴────────┐
    │ Parallel Execution│
    └─────────┬────────┘
              │
    ┌─────────┴─────────────────────────────────┐
    │                                           │
    ▼         ▼         ▼           ▼           │
┌─────────┐ ┌──────────┐ ┌──────────┐ ┌────────┐│
│Blacklist│ │Whitelist │ │Guideline │ │InfoComm││
│  Tool   │ │   Tool   │ │   Tool   │ │LawTool ││
└─────────┘ └──────────┘ └──────────┘ └────────┘│
    │         │           │           │         │
    └─────────┴───────────┴───────────┴─────────┘
              │
              ▼
    ┌──────────────────┐
    │ Validation Results│
    │ + Context Data   │
    └─────────┬────────┘
              │
              ▼
    ┌──────────────────┐
    │ Template Generation│
    │ (Gemini 2.5 Flash) │
    └──────────────────┘
```

### Agent2 핵심 컴포넌트

#### 1. 병렬 도구 실행기 (Parallel Tool Executor)
```python
# src/agents/agent2.py
class Agent2:
    def __init__(self):
        self.tools = {
            "blacklist": BlacklistTool(),
            "whitelist": WhitelistTool(), 
            "guideline": GuidelineTool(),
            "law": InfoCommLawTool()
        }
        
    def parallel_validate(self, user_input):
        # RunnableParallel을 사용한 병렬 실행
        parallel_results = self.runnable_parallel.invoke({
            "input": user_input
        })
        return self._merge_results(parallel_results)
```

#### 2. 컨텍스트 통합기 (Context Integrator)
- 4개 도구의 결과를 하나의 컨텍스트로 통합
- 정책 준수 여부 판단
- 최적의 템플릿 생성을 위한 가이드라인 제공

#### 3. 템플릿 생성기 (Template Generator)
- Gemini 2.5 Flash와 연동
- 통합된 컨텍스트 기반 템플릿 생성
- 변수 추출 및 포맷팅

## 🔍 FAISS 벡터 검색 시스템

### 인덱스 구조
```
cache/
├── faiss_index_policy.bin          # 정책 문서 인덱스
├── faiss_index_examples.bin        # 예시 템플릿 인덱스  
├── faiss_index_validation.bin      # 검증 데이터 인덱스
├── document_chunks_policy.pkl      # 정책 문서 청크
├── document_chunks_examples.pkl    # 예시 템플릿 청크
└── document_chunks_validation.pkl  # 검증 데이터 청크
```

### 벡터 검색 프로세스
1. **임베딩 생성**: Google Embedding-001 모델 사용
2. **유사도 검색**: FAISS L2 거리 기반 검색
3. **컨텍스트 선택**: Top-K 유사 문서 선택 (기본값: K=5)
4. **컨텍스트 통합**: 선택된 문서들을 하나의 컨텍스트로 결합

### 성능 최적화
- **캐싱**: 인덱스 메모리 캐싱으로 빠른 검색
- **배치 처리**: 여러 쿼리 동시 처리 지원
- **압축**: FAISS IndexIVF 압축 인덱스 사용

## 🛠️ Core 모듈 아키텍처

### 1. TemplateGenerator (`src/core/template_generator.py`)
```python
class TemplateGenerator(BaseTemplateProcessor):
    def __init__(self):
        self.agent2 = Agent2()
        self.index_manager = IndexManager()
        
    def generate_template(self, user_input):
        # 1. 날짜 전처리
        processed_input = self.preprocess_dates(user_input)
        
        # 2. Agent2 병렬 검증
        validation_results = self.agent2.parallel_validate(processed_input)
        
        # 3. 벡터 검색
        context = self.index_manager.similarity_search(processed_input)
        
        # 4. 템플릿 생성
        return self.generate_with_context(validation_results, context)
```

### 2. IndexManager (`src/core/index_manager.py`)
- FAISS 인덱스 로딩/저장
- 벡터 임베딩 생성
- 유사도 검색 인터페이스
- 캐시 관리

### 3. EntityExtractor (`src/core/entity_extractor.py`)
- 변수 추출 (#{변수명} 패턴)
- 엔티티 분류 (날짜, 이름, 금액 등)
- 6W 분석 (Who, What, When, Where, Why, hoW)

## 🔧 도구 시스템 (Tools)

### 정책 검증 도구
1. **BlacklistTool**: 금지 키워드 검사
2. **WhitelistTool**: 허용 패턴 검증  
3. **InfoCommLawTool**: 정보통신법 준수 검사
4. **GuidelineTool**: 카카오톡 알림톡 가이드라인 검증

### 전처리 도구
1. **DatePreprocessor**: 자연어 날짜 → 실제 날짜 변환
2. **IntentClassifier**: 사용자 의도 분류
3. **VariableExtractor**: 동적 변수 추출

### 도구 통합 인터페이스
```python
# src/tools/__init__.py
from .blacklist_tool import BlacklistTool
from .whitelist_tool import WhitelistTool
from .info_comm_law_tool import InfoCommLawTool
from .date_preprocessor import DatePreprocessor

__all__ = [
    'BlacklistTool',
    'WhitelistTool', 
    'InfoCommLawTool',
    'DatePreprocessor'
]
```

## 🌐 API 계층 아키텍처

### FastAPI 서버 구조 (`server.py`)
```python
app = FastAPI()
template_api = get_template_api()  # api.py 싱글톤

@app.post("/ai/templates")
async def create_template(request: TemplateCreationRequest):
    # 1. 요청 검증
    # 2. 템플릿 생성 (api.py 위임)
    # 3. JSON 변환
    # 4. 응답 반환
```

### API 유틸리티 (`api.py`)
```python
class TemplateAPI:
    def __init__(self):
        self.template_generator = TemplateGenerator()
        
    def generate_template(self, user_input):
        # 핵심 생성 로직
        
    def export_to_json(self, result, user_input, user_id):
        # 기업 DB 스키마 매핑
```

## 📊 데이터 플로우

### 1. 요청 처리 플로우
```
HTTP Request → FastAPI → API Layer → Core Engine → Agent2 → Tools → Response
     ↓            ↓          ↓           ↓          ↓       ↓        ↓
   JSON Input  Request   Template    Agent2    4-Tool   Results   JSON Output
              Validation Generator  Orchestrator Parallel          
```

### 2. 데이터 변환 플로우
```
User Input → Date Processing → Intent Classification → Context Search → Template Generation
    ↓              ↓                   ↓                    ↓              ↓
"다음 주 화요일"  "2025-09-09"      "교육/일정"        Vector Search    Final Template
```

## 🔄 확장성 설계

### 마이크로서비스 준비
- **독립적 컴포넌트**: 각 모듈이 독립적으로 동작
- **API 기반 통신**: RESTful API로 서비스 간 통신
- **상태 비저장**: 세션 정보 없는 무상태 설계

### 수평 확장 지원
- **Load Balancing**: FastAPI + Uvicorn 멀티 워커
- **캐시 외부화**: Redis/Memcached 연동 준비
- **DB 분리**: 메타데이터/벡터DB 분리 가능

### 플러그인 아키텍처
- **도구 확장**: 새로운 검증 도구 추가 용이
- **모델 교체**: AI 모델 교체 인터페이스 제공
- **커스텀 분류기**: 업종별 분류기 추가 지원

## 📈 성능 모니터링

### 메트릭 수집 포인트
- API 응답 시간
- Agent2 실행 시간
- FAISS 검색 시간
- 메모리 사용률
- 템플릿 생성 성공률

### 로깅 구조
```python
import logging

# 구조화된 로깅
logger = logging.getLogger("jober_ai")
logger.info("Template generated", extra={
    "user_id": user_id,
    "category_id": category_id,
    "generation_time": elapsed_time,
    "success": True
})
```

---

**이전 문서**: [02_API_사용법.md](./02_API_사용법.md)  
**다음 문서**: [04_개발_가이드.md](./04_개발_가이드.md)