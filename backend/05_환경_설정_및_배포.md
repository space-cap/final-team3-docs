# 05. 환경 설정 및 배포

## 환경 개요

이 프로젝트는 로컬 개발 환경부터 운영 환경까지 다양한 설정을 지원하는 멀티 프로파일 아키텍처를 채택했습니다.

### 지원 환경
- **로컬 개발 환경**: 기본 프로파일 (포트 8080)
- **통합 개발 환경**: dev 프로파일 (포트 8580)
- **운영 환경**: 환경변수 기반 설정 (향후 확장)

## 개발 환경 설정

### 필수 요구사항
- **Java**: 21 (LTS 권장, JDK 23도 호환)
- **Maven**: 3.8 이상
- **Docker**: MySQL 컨테이너 실행용
- **IDE**: IntelliJ IDEA (권장)

### 로컬 환경 구성

#### 1. 프로젝트 클론 및 초기 설정
```bash
# 레포지토리 클론
git clone https://github.com/Kernel180-BE12/Final3team-jober_to_java.git
cd Final3team-jober_to_java

# 권한 설정 (Linux/macOS)
chmod +x mvnw
```

#### 2. MySQL 데이터베이스 실행 (Docker)
```bash
# Docker Compose로 MySQL 실행
docker compose up -d

# 컨테이너 상태 확인
docker ps

# 로그 확인
docker logs -f demo-mysql
```

**Docker Compose 설정**:
```yaml
services:
  mysql:
    image: mysql:8.0.42
    container_name: demo-mysql
    restart: unless-stopped
    environment:
      MYSQL_ROOT_PASSWORD: rootpw
      MYSQL_DATABASE: appdb
      TZ: Asia/Seoul
    ports:
      - "3500:3306"   # dev 프로파일용 (3307은 Windows 예약 포트 충돌 회피)
    command: [
      "--character-set-server=utf8mb4",
      "--collation-server=utf8mb4_general_ci", 
      "--default-time-zone=+09:00"
    ]
    healthcheck:
      test: ["CMD-SHELL", "mysqladmin ping -h localhost -prootpw || exit 1"]
      interval: 5s
      timeout: 3s
      retries: 20
    volumes:
      - ./dbdata:/var/lib/mysql
```

#### 3. 애플리케이션 실행

**Maven 명령어**:
```bash
# 컴파일
./mvnw clean compile

# 테스트 (구현 시)
./mvnw test

# 패키지 생성
./mvnw clean package

# 애플리케이션 실행 (기본 프로파일)
./mvnw spring-boot:run

# dev 프로파일로 실행
./mvnw spring-boot:run -Dspring-boot.run.profiles=dev
```

**IDE에서 실행**:
- Main Class: `FinalProjectsApplication.java`
- VM Options: `-Dspring.profiles.active=dev` (dev 프로파일 사용 시)
- Environment Variables: 필요 시 설정

## 프로파일별 설정

### 기본 프로파일 (application.yml)
```yaml
spring:
  datasource:
    url: jdbc:mysql://localhost:3307/appdb?createDatabaseIfNotExist=true&allowPublicKeyRetrieval=true&useSSL=false&serverTimezone=Asia/Seoul&characterEncoding=UTF-8
    username: root
    password: rootpw
    hikari:
      maximum-pool-size: 10

  jpa:
    hibernate:
      ddl-auto: update     # 개발 중에는 update, 운영에서는 validate 권장
    open-in-view: false
    properties:
      hibernate:
        format_sql: true
        jdbc.time_zone: Asia/Seoul

  jackson:
    time-zone: Asia/Seoul

management:
  endpoints:
    web:
      exposure:
        include: health,info

server:
  port: 8080

management:
  endpoints:
    web:
      exposure:
        include: health,mappings
  endpoint:
    health:
      show-details: always
```

### dev 프로파일 (application-dev.yml)
```yaml
spring:
  datasource:
    url: jdbc:mysql://localhost:3500/appdb?createDatabaseIfNotExist=true&allowPublicKeyRetrieval=true&useSSL=false&serverTimezone=Asia/Seoul&characterEncoding=UTF-8
    username: root
    password: rootpw
  jpa:
    hibernate:
      ddl-auto: validate    # Flyway와 함께 사용 시 validate 모드
  flyway:
    enabled: true
    locations: classpath:db/migration,classpath:db/seed

server:
  port: 8580

management:
  endpoints:
    web:
      exposure:
        include: health,info

logging:
  level:
    org.flywaydb: DEBUG     # Flyway 로그 활성화

# 개발환경용 JWT 설정 (운영환경에서는 환경변수 사용)
jwt:
  secret: bqRgdYiJ8PphtR0lZhoo8Rzch+TJechjMOyF9+j8pSQ=
  access-validaity-ms: 1800000   # 30분
  refresh-validity-ms: 1209600000 # 14일
```

## 데이터베이스 마이그레이션

### Flyway 설정
- **활성화**: dev 프로파일에서만 사용
- **마이그레이션 경로**: `classpath:db/migration`
- **시드 데이터 경로**: `classpath:db/seed`

### 스키마 마이그레이션 파일
**위치**: `src/main/resources/db/migration/`

**V1__create_tables.sql** (핵심 테이블):
```sql
CREATE TABLE user (
    id BIGINT NOT NULL AUTO_INCREMENT,
    email VARCHAR(255) NOT NULL,
    password_hash VARCHAR(255) NOT NULL,
    name VARCHAR(100) NULL,
    status VARCHAR(20) NOT NULL DEFAULT 'PENDING',
    locked BIT(1) NOT NULL DEFAULT b'0',
    locked_at DATETIME NULL,
    last_login_at DATETIME NULL,
    created_at DATETIME NOT NULL,
    updated_at DATETIME NOT NULL,
    fail_count INT NOT NULL DEFAULT 0,
    CONSTRAINT PK_USER PRIMARY KEY (id)
);

-- 템플릿 관련 테이블들...
CREATE TABLE template (
    id BIGINT NOT NULL AUTO_INCREMENT,
    user_id BIGINT NOT NULL,
    category_id BIGINT NOT NULL,
    user_template_request_id BIGINT NULL,
    title VARCHAR(255) NULL,
    content LONGTEXT NULL,
    status ENUM('CREATED','APPROVE_REQUESTED','APPROVED','REJECTED','DELETED') NULL,
    type ENUM('LINK','MESSAGE','DOCUMENT') NULL,
    is_public BOOLEAN NULL,
    image_url VARCHAR(500) NULL,
    reject_reason VARCHAR(500) NULL,
    reject_reason_summary VARCHAR(500) NULL,
    created_at TIMESTAMP NULL,
    updated_at TIMESTAMP NULL,
    CONSTRAINT PK_TEMPLATE PRIMARY KEY (id)
);
```

### 시드 데이터
**위치**: `src/main/resources/db/seed/`

주요 시드 파일들:
- `R__user.sql`: 테스트 사용자 데이터
- `R__category.sql`: 템플릿 카테고리
- `R__industry.sql`: 산업군 마스터 데이터
- `R__purpose.sql`: 목적 마스터 데이터
- `R__template.sql`: 샘플 템플릿 데이터

## 애플리케이션 설정

### Spring Boot 설정
```java
@EnableJpaAuditing          // 엔티티 감사 기능
@SpringBootApplication
public class FinalProjectsApplication {
    public static void main(String[] args) {
        SpringApplication.run(FinalProjectsApplication.class, args);
    }
}
```

### JPA 설정
```yaml
spring:
  jpa:
    hibernate:
      ddl-auto: update      # 개발: update, 운영: validate
    open-in-view: false     # OSIV 비활성화로 성능 최적화
    properties:
      hibernate:
        format_sql: true    # SQL 포맷팅
        jdbc.time_zone: Asia/Seoul  # 타임존 설정
```

### HikariCP 커넥션 풀
```yaml
spring:
  datasource:
    hikari:
      maximum-pool-size: 10           # 최대 커넥션 수
      minimum-idle: 5                 # 최소 유휴 커넥션
      idle-timeout: 300000           # 유휴 커넥션 타임아웃 (5분)
      max-lifetime: 1800000          # 커넥션 최대 생명주기 (30분)
      connection-timeout: 30000      # 커넥션 타임아웃 (30초)
```

## 모니터링 및 헬스체크

### Spring Actuator 설정
```yaml
management:
  endpoints:
    web:
      exposure:
        include: health,info,mappings
  endpoint:
    health:
      show-details: always
```

### 헬스체크 엔드포인트
```java
@RestController
public class DbHealthController {
    @GetMapping("/health/db")
    public Map<String, Object> healthCheck() {
        try {
            // DB 연결 테스트 로직
            return Map.of("ok", true);
        } catch (Exception e) {
            return Map.of("ok", false, "error", e.getMessage());
        }
    }
}
```

**사용법**:
```bash
# 기본 헬스체크
curl http://localhost:8080/actuator/health

# 데이터베이스 헬스체크
curl http://localhost:8080/health/db

# 애플리케이션 정보
curl http://localhost:8080/actuator/info
```

## API 문서화

### SpringDoc OpenAPI 설정
```java
@Configuration
public class SwaggerConfig {
    @Bean
    public OpenAPI customOpenAPI() {
        return new OpenAPI()
            .info(new Info()
                .title("Template Management API")
                .version("1.0.0")
                .description("AI 기반 템플릿 생성 및 관리 시스템"))
            .addSecurityItem(new SecurityRequirement().addList("JWT"))
            .components(new Components()
                .addSecuritySchemes("JWT", new SecurityScheme()
                    .type(SecurityScheme.Type.HTTP)
                    .scheme("bearer")
                    .bearerFormat("JWT")));
    }
}
```

**Swagger UI 접속**:
- URL: `http://localhost:8080/swagger-ui.html`
- API 문서: `http://localhost:8080/v3/api-docs`

## 배포 설정

### JAR 빌드
```bash
# JAR 파일 생성
./mvnw clean package

# 생성 위치: target/final_projects-0.0.1-SNAPSHOT.jar

# 실행
java -jar target/final_projects-0.0.1-SNAPSHOT.jar

# 프로파일 지정 실행
java -jar -Dspring.profiles.active=dev target/final_projects-0.0.1-SNAPSHOT.jar
```

### Docker 이미지 생성 (향후 구현)
```dockerfile
FROM openjdk:21-jre-slim

WORKDIR /app
COPY target/final_projects-0.0.1-SNAPSHOT.jar app.jar

EXPOSE 8080

ENTRYPOINT ["java", "-jar", "app.jar"]
```

### 환경변수 기반 운영 설정
```yaml
# application-prod.yml (운영환경)
spring:
  datasource:
    url: ${DB_URL}
    username: ${DB_USERNAME}
    password: ${DB_PASSWORD}

jwt:
  secret: ${JWT_SECRET}
  access-validaity-ms: ${JWT_ACCESS_VALIDITY_MS:900000}    # 15분
  refresh-validity-ms: ${JWT_REFRESH_VALIDITY_MS:604800000} # 7일

logging:
  level:
    com.example.final_projects: INFO
    org.springframework.security: WARN
```

## Git 브랜치 전략

### 브랜치 구조
- **main**: 배포/안정 버전
- **develop**: 통합 개발 브랜치 (향후 추가)
- **feature/***: 기능 개발용 브랜치
- **fix/***: 버그 수정 브랜치
- **hotfix/***: 긴급 패치 브랜치

### 브랜치 사용 예시
```bash
# 기능 개발
git checkout -b feature/user-management
git push origin feature/user-management

# 버그 수정
git checkout -b fix/jwt-token-validation
git push origin fix/jwt-token-validation

# 핫픽스 
git checkout -b hotfix/security-patch
git push origin hotfix/security-patch
```

## 개발자 환경 체크리스트

### 초기 설정
- [ ] JDK 21+ 설치 확인
- [ ] Maven 설치 및 PATH 설정
- [ ] Docker Desktop 설치 및 실행
- [ ] IntelliJ IDEA 설치 및 플러그인 설정
- [ ] Git 설정 및 SSH 키 등록

### 프로젝트 설정
- [ ] `git clone` 및 프로젝트 import
- [ ] `docker compose up -d`로 MySQL 실행 확인
- [ ] `./mvnw spring-boot:run` 실행 성공
- [ ] `http://localhost:8080/health/db` 응답 확인
- [ ] Swagger UI (`/swagger-ui.html`) 접속 확인

### 개발 도구 설정
- [ ] IDE에서 Maven 자동 import 설정
- [ ] Code style 설정 (Google Java Style 권장)
- [ ] Lombok 플러그인 설치 및 annotation processing 활성화
- [ ] Database 툴 연결 (MySQL Workbench, DBeaver 등)

## 트러블슈팅

### 자주 발생하는 문제

#### 1. 포트 충돌
```bash
# 포트 사용 중인 프로세스 확인 (Windows)
netstat -ano | findstr :8080

# 포트 사용 중인 프로세스 확인 (Linux/macOS)  
lsof -i :8080

# 해결: 다른 포트 사용 또는 프로세스 종료
```

#### 2. MySQL 연결 실패
```bash
# Docker 컨테이너 상태 확인
docker ps -a

# MySQL 로그 확인
docker logs demo-mysql

# 컨테이너 재시작
docker compose down && docker compose up -d
```

#### 3. Flyway 마이그레이션 실패
```bash
# Flyway 히스토리 확인
SELECT * FROM flyway_schema_history;

# 실패한 마이그레이션 수동 정리
DELETE FROM flyway_schema_history WHERE success = 0;
```

#### 4. 메모리 부족
```bash
# JVM 힙 크기 조정
export MAVEN_OPTS="-Xmx2g -Xms1g"

# 또는 실행 시 옵션 추가
java -Xmx2g -jar target/final_projects-0.0.1-SNAPSHOT.jar
```

이러한 환경 설정을 통해 개발팀이 일관된 환경에서 효율적으로 협업할 수 있으며, 운영환경으로의 배포도 원활하게 진행할 수 있습니다.